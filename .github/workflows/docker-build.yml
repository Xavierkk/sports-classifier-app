name: Build and Push Docker Image

on:
  push:
    branches:
      - master  # or main if your branch is main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    # Added permissions to allow the bot to create new tags in your repo
    permissions:
      contents: write 

    steps:
    # Step 1: Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
        fetch-depth: '0' # Added to allow version counter to see previous tags

    # Step 1.5: Pull LFS files (Safety step)
    - name: Pull LFS files
      run: git lfs pull

    # --- NEW STEP: Auto-Increment Version ---
    - name: Bump version and push tag
      id: tag_version
      uses: anothrNick/github-tag-action@1.64.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: true
        DEFAULT_BUMP: patch # This ensures v1.0.1 -> v1.0.2

    # Step 2: Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Step 3: Log in to DockerHub
    - name: Log in to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # Step 4: Build & Push Docker image (Updated with multiple tags)
    - name: Build and Push Docker image
      run: |
        docker build -t xavierkk/sports-classifier:latest \
                     -t xavierkk/sports-classifier:${{ steps.tag_version.outputs.new_tag }} .
        docker push xavierkk/sports-classifier:latest
        docker push xavierkk/sports-classifier:${{ steps.tag_version.outputs.new_tag }}
